# 微信超级查询
* ESAP提供了快速对接微信公众号/企业号的回调接口，自定义SQL语句，自定义权限，实现引擎式超级查询。
* 需配置应用的token和EncodingAesKey，回调URL规则：
	`http://外网host/wx/应用名`

例如，假设外网域名是io.erp8.net，9090端口映射到内网ESAP服务器，那么回调URL如下:
	`http://io.erp8.net:9090/wx/esap`

> 注意，公众号(服务号/订阅号)必须使用80端口，如无80端口可以用nginx或caddy做反向代理。

## 微信查询原理
* 系统根据用户输入的第一个关键字（例如下图的`库存`），扫描esap_cx表中对应的sql，执行并返回结果。
* 其他关键字被视为查询参数（例如下图中的`名`,`手机`），sql中可以使用`:p1,:p2`替换where条件。

> select 品号,名 as 品名,库存 from 库存表 where {\{.p1\}} like '%{\{.p2\}}%'

![](./img/s2.png)

## 参数解释

* 用户的输入(逗号空格分隔)会被解析为p0,p1,p2...pn,以及一个特别的P(大写)代表所有输入内容

例如用户输入：`库存，手机，一号仓` 会被解析为参数组：`p0=库存，p1=手机，p2=一号仓,P=库存，手机，一号仓`

* 在sql中使用\{\{.pn\}\}作参数替换，如果跟在等号（=）后面作为值替换，可以直接使用:pn，例如： 

> select 姓名,工号 from \{\{.p0\}\} where 姓名=:p1

* 要注意的是golang原生模板\{\{.pn\}\}形式用在文本型值位置应该加上单引号，以免被sql误认为是字段，而`:pn`形式则不需要。

所以上面的语句等价于： 
> select 姓名,工号 from \{\{.p0\}\} where 姓名='\{\{.p1\}\}'

**微信查询使用的必要前提是会sql，请自行学习！**

## 数据字典
微信查询主要扫描`esap_cx`表，对应字段解析如下：

|字段|描述|必填|备注|
|:----:|:--:|:--:|:----|
|mKey|微信自定义菜单id|否|绑定菜单id|
|name|查询名称|是|绑定查询第一个关键字|
|entermsg|进入提醒|否|可以是一个select语句|
|tmpl|sql模板|是||
|aclUser|用户权限|否|@all代表全体可用|
|aclDept|部门权限|否|逗号隔开多个ID或名称|
|aclTag|标签权限|否|逗号隔开多个ID或名称|
|aclApp|应用权限|是|逗号(小写)隔开多个配置应用名或用@all|
|mode|模式|否|1代表仅返回图片或附件|
|nextFn|下一步|否|下一步任意输入必然执行指定查询|
|app|专用查询|否|绑定一个配置的应用名,即专用查询|
|db|数据库名称|否|跨账套|
|url|文章URL|否|有值时返回文章，可使用{\{.pn\}}参数|
|pic|文章封面图片|否||
|safe|保密消息模式|否|1表示保密|
|id|自增编号|否|唯一|

* sql模板位置：sql/esap/wxcx.get